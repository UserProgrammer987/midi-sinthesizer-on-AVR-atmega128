#include <avr/io.h>
#define F_CPU 11059200UL
#include <util/delay.h>
#include <avr/interrupt.h>
#include <stdbool.h>
#include <string.h>
#include <math.h>
#include <stdio.h>
#include <avr/pgmspace.h>

#define RS 5 // нога PE0(proteus)/PD5 к RS подключена
#define RW 4 // нога PE1(proteus)/PD4 к RW подключена
#define E 6 // нога PE2(proteus)/PD6 к E подключена

#define A0    21
#define AS0   22
#define B0    23
#define C1    24
#define CS1   25
#define D1    26
#define DS1   27
#define E1    28
#define F1    29
#define FS1   30
#define G1    31
#define GS1   32
#define A1    33
#define AS1   34
#define B1    35
#define C2    36
#define CS2   37
#define D2    38
#define DS2   39
#define E2    40
#define F2    41
#define FS2   42
#define G2    43
#define GS2   44
#define A2    45
#define AS2   46
#define B2    47
#define C3    48
#define CS3   49
#define D3    50
#define DS3   51
#define E3    52
#define F3    53
#define FS3   54
#define G3    55
#define GS3   56
#define A3    57
#define AS3   58
#define B3    59
#define C4    60
#define CS4   61
#define D4    62
#define DS4   63
#define E4    64
#define F4    65
#define FS4   66
#define G4    67
#define GS4   68
#define A4    69
#define AS4   70
#define B4    71
#define C5    72
#define CS5   73
#define D5    74
#define DS5   75
#define E5    76
#define F5    77
#define FS5   78
#define G5    79
#define GS5   80
#define A5    81
#define AS5   82
#define B5    83
#define C6    84
#define CS6   85
#define D6    86
#define DS6   87
#define E6    88
#define F6    89
#define FS6   90
#define G6    91
#define GS6   92
#define A6    93
#define AS6   94
#define B6    95
#define C7    96
#define CS7   97
#define D7    98
#define DS7   99
#define E7    100

#define ZADERSHKA 125

uint16_t timeMs = 0;

void setTimeZero(){
    TCNT1 = 0;
    timeMs = 0;
}

uint16_t getTimeMs(){
    return timeMs;
}

static const uint8_t sine[256] = {
    127, 130, 133, 136, 139, 143, 146, 149, 152, 155, 158, 161, 164, 167, 170, 173,
    176, 179, 182, 184, 187, 190, 193, 195, 198, 200, 203, 205, 208, 210, 213, 215,
    217, 219, 221, 224, 226, 228, 229, 231, 233, 235, 236, 238, 239, 241, 242, 244,
    245, 246, 247, 248, 249, 250, 251, 251, 252, 253, 253, 254, 254, 254, 254, 254,
    255, 254, 254, 254, 254, 254, 253, 253, 252, 251, 251, 250, 249, 248, 247, 246,
    245, 244, 242, 241, 239, 238, 236, 235, 233, 231, 229, 228, 226, 224, 221, 219,
    217, 215, 213, 210, 208, 205, 203, 200, 198, 195, 193, 190, 187, 184, 182, 179,
    176, 173, 170, 167, 164, 161, 158, 155, 152, 149, 146, 143, 139, 136, 133, 130,
    127, 124, 121, 118, 115, 111, 108, 105, 102,  99,  96,  93,  90,  87,  84,  81,
     78,  75,  72,  70,  67,  64,  61,  59,  56,  54,  51,  49,  46,  44,  41,  39,
     37,  35,  33,  30,  28,  26,  25,  23,  21,  19,  18,  16,  15,  13,  12,  10,
      9,   8,   7,   6,   5,   4,   3,   3,   2,   1,   1,   0,   0,   0,   0,   0,
      0,   0,   0,   0,   0,   0,   1,   1,   2,   3,   3,   4,   5,   6,   7,   8,
      9,  10,  12,  13,  15,  16,  18,  19,  21,  23,  25,  26,  28,  30,  33,  35,
     37,  39,  41,  44,  46,  49,  51,  54,  56,  59,  61,  64,  67,  70,  72,  75,
     78,  81,  84,  87,  90,  93,  96,  99, 102, 105, 108, 111, 115, 118, 121, 124,
};

#define TABLE_SIZE 256
#define TABLE_BITS 8
#define SAMPLE_RATE 15935

static const uint16_t phase_step[101] = {
        33,     35,     37,     39,     42,     44,     47,     50,
        53,     56,     59,     63,     67,     71,     75,     79,
        84,     89,     95,    100,    106,    113,    119,    126,
       134,    142,    150,    159,    169,    179,    190,    201,
       213,    226,    239,    253,    268,    284,    301,    319,
       338,    359,    380,    403,    427,    452,    479,    507,
       537,    569,    603,    639,    677,    718,    760,    806,
       854,    904,    958,   1015,   1075,   1139,   1207,   1279,
      1355,   1436,   1521,   1612,   1708,   1809,   1917,   2031,
      2151,   2279,   2415,   2559,   2711,   2872,   3043,   3224,
      3416,   3619,   3834,   4062,   4303,   4559,   4831,   5118,
      5422,   5745,   6086,   6448,   6832,   7238,   7668,   8124,
      8607,   9119,   9662,  10236,  10845,
};

static inline uint16_t phase[101] = {0};

void init_phase_accumulators(void){
    for (uint8_t i = 0; i<101; i++){
        phase[i] = 0;
    }
}

void allPhaseNullify(void){
    for (uint8_t i = 0; i<101; i++){
        phase[i] = 0;
    }
}

static inline uint8_t get_amplitude_note(uint8_t note)
{   
    if (note == 0){
        return 0;
    }

    phase[note] += phase_step[note]; return sine[phase[note] >> 8];
}


typedef struct {
    uint8_t note;
    bool note_switch; // 0-ноту вырубить 1-ноту врубить
    uint8_t channel_num; // на какой канал врубить/вырубить ноту, их 8, от 0 до 7
    uint32_t tick; // На каком тике прерывания выполнить действие

} event;


uint8_t channel_note[8];


static const event megalovania[] PROGMEM =
{
    {D4, 1, 0, 0}, {D4, 0, 0, 1991}, {D4, 1, 0, 2070}, {D4, 0, 0, 4061}, {D5, 1, 0, 4140}, {D5, 0, 0, 8202}, {A4, 1, 0, 8281}, {A4, 0, 0, 14413}, {GS4, 1, 0, 14492}, {GS4, 0, 0, 18554}, {G4, 1, 0, 18633}, {G4, 0, 0, 22695}, {F4, 1, 0, 22774}, {F4, 0, 0, 26835}, {D4, 1, 0, 26915}, {D4, 0, 0, 28906}, {F4, 1, 0, 28985}, {F4, 0, 0, 30976}, {G4, 1, 0, 31055}, {G4, 0, 0, 33046}, {C4, 1, 0, 33126}, {C4, 0, 0, 35117}, {C4, 1, 0, 35196}, {C4, 0, 0, 37187}, {D5, 1, 0, 37267}, {D5, 0, 0, 41328}, {A4, 1, 0, 41407}, {A4, 0, 0, 47539}, {GS4, 1, 0, 47619}, {GS4, 0, 0, 51680}, {G4, 1, 0, 51759}, {G4, 0, 0, 55821}, {F4, 1, 0, 55900}, {F4, 0, 0, 59962}, {D4, 1, 0, 60041}, {D4, 0, 0, 62032}, {F4, 1, 0, 62111}, {F4, 0, 0, 64102}, {G4, 1, 0, 64182}, {G4, 0, 0, 66173}, {B3, 1, 0, 66252}, {B3, 0, 0, 68243}, {B3, 1, 0, 68323}, {B3, 0, 0, 70314}, {D5, 1, 0, 70393}, {D5, 0, 0, 74454}, {A4, 1, 0, 74534}, {A4, 0, 0, 80666}, {GS4, 1, 0, 80745}, {GS4, 0, 0, 84806}, {G4, 1, 0, 84886}, {G4, 0, 0, 88947}, {F4, 1, 0, 89027}, {F4, 0, 0, 93088}, {D4, 1, 0, 93167}, {D4, 0, 0, 95158}, {F4, 1, 0, 95238}, {F4, 0, 0, 97229}, {G4, 1, 0, 97308}, {G4, 0, 0, 99299}, {AS3, 1, 0, 99379}, {AS3, 0, 0, 101370}, {AS3, 1, 0, 101449}, {AS3, 0, 0, 103440}, {D5, 1, 0, 103519}, {D5, 0, 0, 107581}, {A4, 1, 0, 107660}, {A4, 0, 0, 113792}, {GS4, 1, 0, 113871}, {GS4, 0, 0, 117933}, {G4, 1, 0, 118012}, {G4, 0, 0, 122074}, {F4, 1, 0, 122153}, {F4, 0, 0, 126214}, {D4, 1, 0, 126294}, {D4, 0, 0, 128285}, {F4, 1, 0, 128364}, {F4, 0, 0, 130355}, {G4, 1, 0, 130435}, {G4, 0, 0, 132426}, {D3, 1, 1, 132505}, {D4, 1, 0, 132506}, {D4, 0, 0, 134496}, {D4, 1, 0, 134575}, {D3, 0, 1, 136566}, {D4, 0, 0, 136567}, {D3, 1, 1, 136646}, {D5, 1, 0, 136647}, {D3, 0, 1, 140707}, {D5, 0, 0, 140708}, {D3, 1, 1, 140786}, {A4, 1, 0, 140787}, {D3, 0, 1, 142778}, {D3, 1, 1, 142857}, {D3, 0, 1, 146918}, {A4, 0, 0, 146919}, {D3, 1, 1, 146998}, {GS4, 1, 0, 146999}, {D3, 0, 1, 151059}, {GS4, 0, 0, 151060}, {D3, 1, 1, 151138}, {G4, 1, 0, 151139}, {D3, 0, 1, 155200}, {G4, 0, 0, 155201}, {D3, 1, 1, 155279}, {F4, 1, 0, 155280}, {D3, 0, 1, 159341}, {F4, 0, 0, 159342}, {D3, 1, 1, 159420}, {D4, 1, 0, 159421}, {D3, 0, 1, 161411}, {D4, 0, 0, 161412}, {D3, 1, 1, 161490}, {F4, 1, 0, 161491}, {F4, 0, 0, 163481}, {G4, 1, 0, 163561}, {D3, 0, 1, 165552}, {G4, 0, 0, 165553}, {C3, 1, 1, 165631}, {C4, 1, 0, 165632}, {C4, 0, 0, 167622}, {C4, 1, 0, 167702}, {C3, 0, 1, 169693}, {C4, 0, 0, 169694}, {C3, 1, 1, 169772}, {D5, 1, 0, 169773}, {C3, 0, 1, 173833}, {D5, 0, 0, 173834}, {C3, 1, 1, 173913}, {A4, 1, 0, 173914}, {C3, 0, 1, 175904}, {C3, 1, 1, 175983}, {C3, 0, 1, 180045}, {A4, 0, 0, 180046}, {C3, 1, 1, 180124}, {GS4, 1, 0, 180125}, {C3, 0, 1, 184185}, {GS4, 0, 0, 184186}, {C3, 1, 1, 184265}, {G4, 1, 0, 184266}, {C3, 0, 1, 188326}, {G4, 0, 0, 188327}, {C3, 1, 1, 188406}, {F4, 1, 0, 188407}, {C3, 0, 1, 192467}, {F4, 0, 0, 192468}, {C3, 1, 1, 192546}, {D4, 1, 0, 192547}, {C3, 0, 1, 194537}, {D4, 0, 0, 194538}, {C3, 1, 1, 194617}, {F4, 1, 0, 194618}, {F4, 0, 0, 196608}, {G4, 1, 0, 196687}, {C3, 0, 1, 198678}, {G4, 0, 0, 198679}, {B2, 1, 1, 198758}, {B3, 1, 0, 198759}, {B3, 0, 0, 200749}, {B3, 1, 0, 200828}, {B2, 0, 1, 202819}, {B3, 0, 0, 202820}, {B2, 1, 1, 202898}, {D5, 1, 0, 202899}, {B2, 0, 1, 206960}, {D5, 0, 0, 206961}, {B2, 1, 1, 207039}, {A4, 1, 0, 207040}, {B2, 0, 1, 209030}, {B2, 1, 1, 209110}, {B2, 0, 1, 213171}, {A4, 0, 0, 213172}, {B2, 1, 1, 213250}, {GS4, 1, 0, 213251}, {B2, 0, 1, 217312}, {GS4, 0, 0, 217313}, {B2, 1, 1, 217391}, {G4, 1, 0, 217392}, {B2, 0, 1, 221453}, {G4, 0, 0, 221454}, {B2, 1, 1, 221532}, {F4, 1, 0, 221533}, {B2, 0, 1, 225593}, {F4, 0, 0, 225594}, {B2, 1, 1, 225673}, {D4, 1, 0, 225674}, {B2, 0, 1, 227664}, {D4, 0, 0, 227665}, {B2, 1, 1, 227743}, {F4, 1, 0, 227744}, {F4, 0, 0, 229734}, {G4, 1, 0, 229814}, {B2, 0, 1, 231805}, {G4, 0, 0, 231806}, {AS2, 1, 1, 231884}, {AS3, 1, 0, 231885}, {AS3, 0, 0, 233875}, {AS3, 1, 0, 233954}, {AS2, 0, 1, 235945}, {AS3, 0, 0, 235946}, {AS2, 1, 1, 236025}, {D5, 1, 0, 236026}, {AS2, 0, 1, 240086}, {D5, 0, 0, 240087}, {AS2, 1, 1, 240166}, {A4, 1, 0, 240167}, {AS2, 0, 1, 242157}, {AS2, 1, 1, 242236}, {AS2, 0, 1, 246297}, {A4, 0, 0, 246298}, {C3, 1, 1, 246377}, {GS4, 1, 0, 246378}, {C3, 0, 1, 250438}, {GS4, 0, 0, 250439}, {C3, 1, 1, 250518}, {G4, 1, 0, 250519}, {C3, 0, 1, 254579}, {G4, 0, 0, 254580}, {C3, 1, 1, 254658}, {F4, 1, 0, 254659}, {C3, 0, 1, 258720}, {F4, 0, 0, 258721}, {C3, 1, 1, 258799}, {D4, 1, 0, 258800}, {C3, 0, 1, 260790}, {D4, 0, 0, 260791}, {C3, 1, 1, 260870}, {F4, 1, 0, 260871}, {F4, 0, 0, 262861}, {G4, 1, 0, 262940}, {C3, 0, 1, 264931}, {G4, 0, 0, 264932}, {D2, 1, 1, 265010}, {D3, 1, 1, 265011}, {D5, 1, 0, 265012}, {D5, 0, 0, 267001}, {D5, 1, 0, 267081}, {D2, 0, 1, 269072}, {D3, 0, 1, 269073}, {D5, 0, 0, 269074}, {D2, 1, 1, 269151}, {D3, 1, 1, 269152}, {D6, 1, 0, 269153}, {D2, 0, 1, 273213}, {D3, 0, 1, 273214}, {D6, 0, 0, 273215}, {D2, 1, 1, 273292}, {D3, 1, 1, 273293}, {A5, 1, 0, 273294}, {D2, 0, 1, 275283}, {D3, 0, 1, 275284}, {D2, 1, 1, 275362}, {D3, 1, 1, 275363}, {D2, 0, 1, 279424}, {D3, 0, 1, 279425}, {A5, 0, 0, 279426}, {D2, 1, 1, 279503}, {D3, 1, 1, 279504}, {GS5, 1, 0, 279505}, {D2, 0, 1, 283565}, {D3, 0, 1, 283566}, {GS5, 0, 0, 283567}, {D2, 1, 1, 283644}, {D3, 1, 1, 283645}, {G5, 1, 0, 283646}, {D2, 0, 1, 287705}, {D3, 0, 1, 287706}, {G5, 0, 0, 287707}, {D2, 1, 1, 287785}, {D3, 1, 1, 287786}, {F5, 1, 0, 287787}, {D2, 0, 1, 291846}, {D3, 0, 1, 291847}, {F5, 0, 0, 291848}, {D2, 1, 1, 291925}, {D3, 1, 1, 291926}, {D5, 1, 0, 291927}, {D2, 0, 1, 293916}, {D3, 0, 1, 293917}, {D5, 0, 0, 293918}, {D2, 1, 1, 293996}, {D3, 1, 1, 293997}, {F5, 1, 0, 293998}, {F5, 0, 0, 295987}, {G5, 1, 0, 296066}, {D2, 0, 1, 298057}, {D3, 0, 1, 298058}, {G5, 0, 0, 298059}, {C2, 1, 1, 298137}, {C3, 1, 1, 298138}, {C5, 1, 0, 298139}, {C5, 0, 0, 300128}, {C5, 1, 0, 300207}, {C2, 0, 1, 302198}, {C3, 0, 1, 302199}, {C5, 0, 0, 302200}, {C2, 1, 1, 302277}, {C3, 1, 1, 302278}, {D6, 1, 0, 302279}, {C2, 0, 1, 306339}, {C3, 0, 1, 306340}, {D6, 0, 0, 306341}, {C2, 1, 1, 306418}, {C3, 1, 1, 306419}, {A5, 1, 0, 306420}, {C2, 0, 1, 308409}, {C3, 0, 1, 308410}, {C2, 1, 1, 308489}, {C3, 1, 1, 308490}, {C2, 0, 1, 312550}, {C3, 0, 1, 312551}, {A5, 0, 0, 312552}, {C2, 1, 1, 312629}, {C3, 1, 1, 312630}, {GS5, 1, 0, 312631}, {C2, 0, 1, 316691}, {C3, 0, 1, 316692}, {GS5, 0, 0, 316693}, {C2, 1, 1, 316770}, {C3, 1, 1, 316771}, {G5, 1, 0, 316772}, {C2, 0, 1, 320832}, {C3, 0, 1, 320833}, {G5, 0, 0, 320834}, {C2, 1, 1, 320911}, {C3, 1, 1, 320912}, {F5, 1, 0, 320913}, {C2, 0, 1, 324972}, {C3, 0, 1, 324973}, {F5, 0, 0, 324974}, {C2, 1, 1, 325052}, {C3, 1, 1, 325053}, {D5, 1, 0, 325054}, {C2, 0, 1, 327043}, {C3, 0, 1, 327044}, {D5, 0, 0, 327045}, {C2, 1, 1, 327122}, {C3, 1, 1, 327123}, {F5, 1, 0, 327124}, {F5, 0, 0, 329113}, {G5, 1, 0, 329193}, {C2, 0, 1, 331184}, {C3, 0, 1, 331185}, {G5, 0, 0, 331186}, {B1, 1, 1, 331263}, {B2, 1, 1, 331264}, {B4, 1, 0, 331265}, {B4, 0, 0, 333254}, {B4, 1, 0, 333333}, {B1, 0, 1, 335324}, {B2, 0, 1, 335325}, {B4, 0, 0, 335326}, {B1, 1, 1, 335404}, {B2, 1, 1, 335405}, {D6, 1, 0, 335406}, {B1, 0, 1, 339465}, {B2, 0, 1, 339466}, {D6, 0, 0, 339467}, {B1, 1, 1, 339545}, {B2, 1, 1, 339546}, {A5, 1, 0, 339547}, {B1, 0, 1, 341536}, {B2, 0, 1, 341537}, {B1, 1, 1, 341615}, {B2, 1, 1, 341616}, {B1, 0, 1, 345676}, {B2, 0, 1, 345677}, {A5, 0, 0, 345678}, {B1, 1, 1, 345756}, {B2, 1, 1, 345757}, {GS5, 1, 0, 345758}, {B1, 0, 1, 349817}, {B2, 0, 1, 349818}, {GS5, 0, 0, 349819}, {B1, 1, 1, 349897}, {B2, 1, 1, 349898}, {G5, 1, 0, 349899}, {B1, 0, 1, 353958}, {B2, 0, 1, 353959}, {G5, 0, 0, 353960}, {B1, 1, 1, 354037}, {B2, 1, 1, 354038}, {F5, 1, 0, 354039}, {B1, 0, 1, 358099}, {B2, 0, 1, 358100}, {F5, 0, 0, 358101}, {B1, 1, 1, 358178}, {B2, 1, 1, 358179}, {D5, 1, 0, 358180}, {B1, 0, 1, 360169}, {B2, 0, 1, 360170}, {D5, 0, 0, 360171}, {B1, 1, 1, 360249}, {B2, 1, 1, 360250}, {F5, 1, 0, 360251}, {F5, 0, 0, 362240}, {G5, 1, 0, 362319}, {B1, 0, 1, 364310}, {B2, 0, 1, 364311}, {G5, 0, 0, 364312}, {AS1, 1, 1, 364389}, {AS2, 1, 1, 364390}, {AS4, 1, 0, 364391}, {AS4, 0, 0, 366380}, {AS4, 1, 0, 366460}, {AS1, 0, 1, 368451}, {AS2, 0, 1, 368452}, {AS4, 0, 0, 368453}, {AS1, 1, 1, 368530}, {AS2, 1, 1, 368531}, {D6, 1, 0, 368532}, {AS1, 0, 1, 372592}, {AS2, 0, 1, 372593}, {D6, 0, 0, 372594}, {AS1, 1, 1, 372671}, {AS2, 1, 1, 372672}, {A5, 1, 0, 372673}, {AS1, 0, 1, 374662}, {AS2, 0, 1, 374663}, {AS1, 1, 1, 374741}, {AS2, 1, 1, 374742}, {AS1, 0, 1, 378803}, {AS2, 0, 1, 378804}, {A5, 0, 0, 378805}, {C2, 1, 1, 378882}, {C3, 1, 1, 378883}, {GS5, 1, 0, 378884}, {C2, 0, 1, 382944}, {C3, 0, 1, 382945}, {GS5, 0, 0, 382946}, {C2, 1, 1, 383023}, {C3, 1, 1, 383024}, {G5, 1, 0, 383025}, {C2, 0, 1, 387084}, {C3, 0, 1, 387085}, {G5, 0, 0, 387086}, {C2, 1, 1, 387164}, {C3, 1, 1, 387165}, {F5, 1, 0, 387166}, {C2, 0, 1, 391225}, {C3, 0, 1, 391226}, {F5, 0, 0, 391227}, {C2, 1, 1, 391305}, {C3, 1, 1, 391306}, {D5, 1, 0, 391307}, {C2, 0, 1, 393296}, {C3, 0, 1, 393297}, {D5, 0, 0, 393298}, {C2, 1, 1, 393375}, {C3, 1, 1, 393376}, {F5, 1, 0, 393377}, {F5, 0, 0, 395366}, {G5, 1, 0, 395445}, {C2, 0, 1, 397436}, {C3, 0, 1, 397437}, {G5, 0, 0, 397438}, {D2, 1, 1, 397516}, {D3, 1, 1, 397517}, {D5, 1, 0, 397518}, {D5, 0, 0, 399507}, {D5, 1, 0, 399586}, {D2, 0, 1, 401577}, {D3, 0, 1, 401578}, {D5, 0, 0, 401579}, {D2, 1, 1, 401656}, {D3, 1, 1, 401657}, {D6, 1, 0, 401658}, {D2, 0, 1, 405718}, {D3, 0, 1, 405719}, {D6, 0, 0, 405720}, {D2, 1, 1, 405797}, {D3, 1, 1, 405798}, {A5, 1, 0, 405799}, {D2, 0, 1, 407788}, {D3, 0, 1, 407789}, {D2, 1, 1, 407868}, {D3, 1, 1, 407869}, {D2, 0, 1, 411929}, {D3, 0, 1, 411930}, {A5, 0, 0, 411931}, {D2, 1, 1, 412008}, {D3, 1, 1, 412009}, {GS5, 1, 0, 412010}, {D2, 0, 1, 416070}, {D3, 0, 1, 416071}, {GS5, 0, 0, 416072}, {D2, 1, 1, 416149}, {D3, 1, 1, 416150}, {G5, 1, 0, 416151}, {D2, 0, 1, 420211}, {D3, 0, 1, 420212}, {G5, 0, 0, 420213}, {D2, 1, 1, 420290}, {D3, 1, 1, 420291}, {F5, 1, 0, 420292}, {D2, 0, 1, 424351}, {D3, 0, 1, 424352}, {F5, 0, 0, 424353}, {D2, 1, 1, 424431}, {D3, 1, 1, 424432}, {D5, 1, 0, 424433}, {D2, 0, 1, 426422}, {D3, 0, 1, 426423}, {D5, 0, 0, 426424}, {D2, 1, 1, 426501}, {D3, 1, 1, 426502}, {F5, 1, 0, 426503}, {F5, 0, 0, 428492}, {G5, 1, 0, 428572}, {D2, 0, 1, 430563}, {D3, 0, 1, 430564}, {G5, 0, 0, 430565}, {C2, 1, 1, 430642}, {C3, 1, 1, 430643}, {C5, 1, 0, 430644}, {C5, 0, 0, 432633}, {C5, 1, 0, 432712}, {C2, 0, 1, 434703}, {C3, 0, 1, 434704}, {C5, 0, 0, 434705}, {C2, 1, 1, 434783}, {C3, 1, 1, 434784}, {D6, 1, 0, 434785}, {C2, 0, 1, 438844}, {C3, 0, 1, 438845}, {D6, 0, 0, 438846}, {C2, 1, 1, 438924}, {C3, 1, 1, 438925}, {A5, 1, 0, 438926}, {C2, 0, 1, 440915}, {C3, 0, 1, 440916}, {C2, 1, 1, 440994}, {C3, 1, 1, 440995}, {C2, 0, 1, 445055}, {C3, 0, 1, 445056}, {A5, 0, 0, 445057}, {C2, 1, 1, 445135}, {C3, 1, 1, 445136}, {GS5, 1, 0, 445137}, {C2, 0, 1, 449196}, {C3, 0, 1, 449197}, {GS5, 0, 0, 449198}, {C2, 1, 1, 449276}, {C3, 1, 1, 449277}, {G5, 1, 0, 449278}, {C2, 0, 1, 453337}, {C3, 0, 1, 453338}, {G5, 0, 0, 453339}, {C2, 1, 1, 453416}, {C3, 1, 1, 453417}, {F5, 1, 0, 453418}, {C2, 0, 1, 457478}, {C3, 0, 1, 457479}, {F5, 0, 0, 457480}, {C2, 1, 1, 457557}, {C3, 1, 1, 457558}, {D5, 1, 0, 457559}, {C2, 0, 1, 459548}, {C3, 0, 1, 459549}, {D5, 0, 0, 459550}, {C2, 1, 1, 459628}, {C3, 1, 1, 459629}, {F5, 1, 0, 459630}, {F5, 0, 0, 461619}, {G5, 1, 0, 461698}, {C2, 0, 1, 463689}, {C3, 0, 1, 463690}, {G5, 0, 0, 463691}, {B1, 1, 1, 463768}, {B2, 1, 1, 463769}, {B4, 1, 0, 463770}, {B4, 0, 0, 465759}, {B4, 1, 0, 465839}, {B1, 0, 1, 467830}, {B2, 0, 1, 467831}, {B4, 0, 0, 467832}, {B1, 1, 1, 467909}, {B2, 1, 1, 467910}, {D6, 1, 0, 467911}, {B1, 0, 1, 471971}, {B2, 0, 1, 471972}, {D6, 0, 0, 471973}, {B1, 1, 1, 472050}, {B2, 1, 1, 472051}, {A5, 1, 0, 472052}, {B1, 0, 1, 474041}, {B2, 0, 1, 474042}, {B1, 1, 1, 474120}, {B2, 1, 1, 474121}, {B1, 0, 1, 478182}, {B2, 0, 1, 478183}, {A5, 0, 0, 478184}, {B1, 1, 1, 478261}, {B2, 1, 1, 478262}, {GS5, 1, 0, 478263}, {B1, 0, 1, 482323}, {B2, 0, 1, 482324}, {GS5, 0, 0, 482325}, {B1, 1, 1, 482402}, {B2, 1, 1, 482403}, {G5, 1, 0, 482404}, {B1, 0, 1, 486463}, {B2, 0, 1, 486464}, {G5, 0, 0, 486465}, {B1, 1, 1, 486543}, {B2, 1, 1, 486544}, {F5, 1, 0, 486545}, {B1, 0, 1, 490604}, {B2, 0, 1, 490605}, {F5, 0, 0, 490606}, {B1, 1, 1, 490684}, {B2, 1, 1, 490685}, {D5, 1, 0, 490686}, {B1, 0, 1, 492675}, {B2, 0, 1, 492676}, {D5, 0, 0, 492677}, {B1, 1, 1, 492754}, {B2, 1, 1, 492755}, {F5, 1, 0, 492756}, {F5, 0, 0, 494745}, {G5, 1, 0, 494824}, {B1, 0, 1, 496815}, {B2, 0, 1, 496816}, {G5, 0, 0, 496817}, {AS1, 1, 1, 496895}, {AS2, 1, 1, 496896}, {AS4, 1, 0, 496897}, {AS4, 0, 0, 498886}, {AS4, 1, 0, 498965}, {AS1, 0, 1, 500956}, {AS2, 0, 1, 500957}, {AS4, 0, 0, 500958}, {AS1, 1, 1, 501036}, {AS2, 1, 1, 501037}, {D6, 1, 0, 501038}, {AS1, 0, 1, 505097}, {AS2, 0, 1, 505098}, {D6, 0, 0, 505099}, {AS1, 1, 1, 505176}, {AS2, 1, 1, 505177}, {A5, 1, 0, 505178}, {AS1, 0, 1, 507167}, {AS2, 0, 1, 507168}, {AS1, 1, 1, 507247}, {AS2, 1, 1, 507248}, {AS1, 0, 1, 511308}, {AS2, 0, 1, 511309}, {A5, 0, 0, 511310}, {C2, 1, 1, 511388}, {C3, 1, 1, 511389}, {GS5, 1, 0, 511390}, {C2, 0, 1, 515449}, {C3, 0, 1, 515450}, {GS5, 0, 0, 515451}, {C2, 1, 1, 515528}, {C3, 1, 1, 515529}, {G5, 1, 0, 515530}, {C2, 0, 1, 519590}, {C3, 0, 1, 519591}, {G5, 0, 0, 519592}, {C2, 1, 1, 519669}, {C3, 1, 1, 519670}, {F5, 1, 0, 519671}, {C2, 0, 1, 523731}, {C3, 0, 1, 523732}, {F5, 0, 0, 523733}, {C2, 1, 1, 523810}, {C3, 1, 1, 523811}, {D5, 1, 0, 523812}, {C2, 0, 1, 525801}, {C3, 0, 1, 525802}, {D5, 0, 0, 525803}, {C2, 1, 1, 525880}, {C3, 1, 1, 525881}, {F5, 1, 0, 525882}, {F5, 0, 0, 527871}, {G5, 1, 0, 527951}, {C2, 0, 1, 529942}, {C3, 0, 1, 529943}, {G5, 0, 0, 529944}, {D3, 1, 1, 530021}, {A3, 1, 1, 530022}, {F5, 1, 0, 530023}, {F5, 0, 0, 532012}, {D3, 0, 1, 534083}, {A3, 0, 1, 534084}, {D3, 1, 1, 534162}, {A3, 1, 1, 534163}, {F5, 1, 0, 534164}, {F5, 0, 0, 536153}, {F5, 1, 0, 536232}, {D3, 0, 1, 538223}, {A3, 0, 1, 538224}, {D3, 1, 1, 538303}, {A3, 1, 1, 538304}, {D3, 0, 1, 540294}, {A3, 0, 1, 540295}, {F5, 0, 0, 540296}, {D3, 1, 1, 540373}, {A3, 1, 1, 540374}, {F5, 1, 0, 540375}, {D3, 0, 1, 544435}, {A3, 0, 1, 544436}, {F5, 0, 0, 544437}, {D3, 1, 1, 544514}, {A3, 1, 1, 544515}, {F5, 1, 0, 544516}, {D3, 0, 1, 548575}, {A3, 0, 1, 548576}, {F5, 0, 0, 548577}, {D3, 1, 1, 548655}, {A3, 1, 1, 548656}, {D5, 1, 0, 548657}, {D3, 0, 1, 552716}, {A3, 0, 1, 552717}, {D5, 0, 0, 552718}, {D3, 1, 1, 552795}, {A3, 1, 1, 552796}, {D5, 1, 0, 552797}, {D3, 0, 1, 556857}, {A3, 0, 1, 556858}, {D3, 1, 1, 556936}, {A3, 1, 1, 556937}, {D3, 0, 1, 558927}, {A3, 0, 1, 558928}, {D3, 1, 1, 559007}, {A3, 1, 1, 559008}, {D3, 0, 1, 563068}, {A3, 0, 1, 563069}, {D5, 0, 0, 563070}, {C3, 1, 1, 563147}, {G3, 1, 1, 563148}, {F5, 1, 0, 563149}, {C3, 0, 1, 567209}, {G3, 0, 1, 567210}, {F5, 0, 0, 567211}, {C3, 1, 1, 567288}, {G3, 1, 1, 567289}, {F5, 1, 0, 567290}, {F5, 0, 0, 569279}, {F5, 1, 0, 569359}, {C3, 0, 1, 571350}, {G3, 0, 1, 571351}, {C3, 1, 1, 571429}, {G3, 1, 1, 571430}, {C3, 0, 1, 573420}, {G3, 0, 1, 573421}, {F5, 0, 0, 573422}, {C3, 1, 1, 573499}, {G3, 1, 1, 573500}, {G5, 1, 0, 573501}, {C3, 0, 1, 577561}, {G3, 0, 1, 577562}, {G5, 0, 0, 577563}, {C3, 1, 1, 577640}, {G3, 1, 1, 577641}, {GS5, 1, 0, 577642}, {C3, 0, 1, 581702}, {G3, 0, 1, 581703}, {GS5, 0, 0, 581704}, {C3, 1, 1, 581781}, {G3, 1, 1, 581782}, {G5, 1, 0, 581783}, {G5, 0, 0, 583772}, {F5, 1, 0, 583851}, {C3, 0, 1, 585842}, {G3, 0, 1, 585843}, {F5, 0, 0, 585844}, {C3, 1, 1, 585922}, {G3, 1, 1, 585923}, {D5, 1, 0, 585924}, {D5, 0, 0, 587913}, {F5, 1, 0, 587992}, {C3, 0, 1, 589983}, {G3, 0, 1, 589984}, {F5, 0, 0, 589985}, {C3, 1, 1, 590063}, {G3, 1, 1, 590064}, {G5, 1, 0, 590065}, {C3, 0, 1, 592054}, {G3, 0, 1, 592055}, {C3, 1, 1, 592133}, {G3, 1, 1, 592134}, {C3, 0, 1, 596194}, {G3, 0, 1, 596195}, {G5, 0, 0, 596196}, {B2, 1, 1, 596274}, {G3, 1, 1, 596275}, {F5, 1, 0, 596276}, {F5, 0, 0, 598265}, {B2, 0, 1, 600335}, {G3, 0, 1, 600336}, {B2, 1, 1, 600415}, {G3, 1, 1, 600416}, {F5, 1, 0, 600417}, {F5, 0, 0, 602406}, {F5, 1, 0, 602485}, {B2, 0, 1, 604476}, {G3, 0, 1, 604477}, {B2, 1, 1, 604555}, {G3, 1, 1, 604556}, {B2, 0, 1, 606546}};

uint16_t music_counter = 0; //счётчик нот
uint16_t counter_of_events = ( sizeof(megalovania) / sizeof(event) ); //счётчик количества событий в песне

#define bpm 230
static uint16_t ms_for_1beat = (60000.3f / bpm); //миллисекунд за бит
uint16_t dlit_ms[];

uint64_t global_event_counter = 0;
uint64_t global_tick_counter = 0;

static inline void do_events(event song[], uint64_t event_counter){
    event ev;
    memcpy_P(&ev, &megalovania[event_counter], sizeof(event));
    uint32_t tick = ev.tick; // На каком тике прерывания сделать действие

    if (tick <= global_tick_counter){
        uint8_t note = ev.note; //нота
        uint8_t num = ev.channel_num; //номер канала
        uint8_t switch_code = ev.note_switch; // Включить или выключить ноту

        if (switch_code){
            channel_note[num] = note;
        }
        else{
            channel_note[num] = 0;
        }
    }
    else{
        return;
    }

    global_event_counter++;
    if (global_event_counter > counter_of_events){
        global_event_counter = 0;
    }
   
}

// доделать release factor
uint8_t release_factor(void){

}

static inline void duty_set(void) {
    OCR0 = (get_amplitude_note(channel_note[0]) + get_amplitude_note(channel_note[1])) / 2;
}




int main(void)
{
    init_phase_accumulators();

    DDRF = 0xFF;

    DDRB = 0xFF;

    TCCR1B = (1 << WGM12) | (1 << CS10); // 11059200/(1+11058) = 1000гц, считает миллисекунды
    OCR1A = 11058;
    TIMSK = (1 << OCIE1A); //прерывание добавляет счётчику миллисекунд 1

    TCCR0 = (1 << CS00) | (1 << COM01) | (1 << WGM01) | (1 << WGM00); // 0-таймер для ШИМ
    // 8-бит ШИМ, нет предделителя(1 в CS00), частота 11052900/256 = 43175 (в proteus измерил, проверил)

    TCCR3B = (1 << WGM32) | (1 << CS30); // 3-таймер для частоты дискретизации музыки, CTC-режим и 1-предделитель
    OCR3A = 690; // считает с частотой 11059200(частота МК)/( 1(предделитель) * (1+690(OCR3A-граница счёта)) = 15935 Гц, наша частота дискретизации
    ETIMSK = (1 << OCIE3A); //прерывание у 3-го таймера по переполнению(которое происходит 15935 раз в секунду) или раз в 63 мкс
    sei();

    while (1) 
    {   
        
    }
}


ISR(TIMER3_COMPA_vect){
    do_events(megalovania, global_event_counter);

    duty_set();

    global_tick_counter++;
}

ISR(TIMER1_COMPA_vect){
    timeMs++;
}